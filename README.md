# 音声録音システム（VAD機能付き）

ブラウザ側でVAD（Voice Activity Detection）処理を行う軽量な音声録音システムです。
話している時だけ自動で録音し、無音部分はカットして効率的に保存できます。

## 🎯 主要機能

### ✅ 実装済み機能

- **リアルタイム音声モニタリング**: 常時マイクから音声レベルを監視
- **音量メーター**: dB表示とプログレスバーで音量を可視化
- **VAD（音声検出）**: 話している時と無音時を自動判別
- **波形表示**: リアルタイムで音声波形を描画
- **マイクデバイス選択**: アクティブな音声入力デバイスを選択可能
- **VAD閾値調整**: -60dB〜-10dBの範囲でリアルタイム調整
- **手動録音**: ボタンで録音開始/停止
- **自動録音**: VAD検出で自動的に録音開始/停止
- **無音時間設定**: 1秒〜5分まで設定可能（デフォルト5秒）
- **録音履歴**: 保存された録音ファイルの一覧・再生・削除
- **WebSocket通信**: リアルタイムでの音声データ送信

### 🔧 技術的特徴

- **エネルギーベースVAD**: 音量レベルによる音声活動検出
- **MediaRecorder API**: ブラウザネイティブな音声録音
- **Web Audio API**: リアルタイム音声解析
- **TypeScript**: 型安全な開発環境
- **Vue 3 Composition API**: モダンなフロントエンド構成

## 🚀 クイックスタート

### 1. 依存関係のインストール

```bash
# Node.js依存関係
npm install

# Python依存関係（rye使用）
rye sync
```

**注意**: Python 3.10以上が必要です。ryeがない場合は以下でインストール:
```bash
# ryeのインストール（macOS/Linux）
curl -sSf https://rye.astral.sh/get | bash

# 手動でPython依存関係をインストールする場合
pip install fastapi uvicorn python-multipart websockets python-dotenv
```

### 2. 同時起動（推奨）

```bash
# サーバー + フロントエンド同時起動
npm start
```

### 3. 個別起動

```bash
# FastAPIサーバーを起動
rye run python server.py

# フロントエンド起動（別ターミナル）
npm run dev
```

### 4. アクセス

ブラウザで `http://localhost:5173` にアクセス

## 📱 使い方

### 初回アクセス時
1. ブラウザがマイクアクセス許可を求めるので **「許可」** をクリック
2. 音量メーターと波形表示が動き始めます
3. 必要に応じてマイクデバイスを選択

### 音声モニタリング
- **音量レベル**: リアルタイムでdB値とプログレスバーが更新
- **VAD状態**: 音声検出中は緑の点が点滅、無音時は灰色
- **波形表示**: 音声波形がリアルタイムで描画（音声検出中は緑色）
- **環境ノイズ**: 起動後に環境ノイズレベルを表示
- **VAD閾値調整**: スライダーで音声検出の感度を調整可能

### 録音機能

#### 手動録音
1. **「手動録音」** タブを選択
2. **「録音開始」** ボタンをクリック
3. 録音中は **「録音停止」** ボタンに変わり、録音時間が表示
4. **「録音停止」** で録音終了、自動的にサーバーに保存

#### 自動録音
1. **「自動録音」** タブを選択
2. 無音時間を設定（1秒〜5分、デフォルト5秒）
3. **「自動録音開始」** をクリック
4. 音声を検出すると自動的に録音開始
5. 設定した無音時間が経過すると自動的に録音停止
6. **「自動録音停止」** で機能を終了

### 録音履歴
- **再生**: 録音ファイルをブラウザで直接再生
- **削除**: ファイル削除（確認ダイアログ付き）
- **ファイル情報**: ファイル名、サイズ、作成日時を表示
- **自動更新**: 新しい録音完了時に履歴が自動更新

## ⚙️ 設定

### 環境変数（.env）
```bash
# サーバー設定
API_HOST=127.0.0.1
API_PORT=8000

# フロントエンド設定
VITE_API_BASE_URL=http://127.0.0.1:8000
VITE_WS_URL=ws://127.0.0.1:8000/ws

# 録音ファイル保存先
AUDIO_SAVE_PATH=./recordings
```

### VAD設定
- **デフォルト閾値**: -35dB
- **調整範囲**: -60dB〜-10dB
- **リアルタイム調整**: UIスライダーで即座に反映

### 無音時間設定
- **デフォルト**: 5秒
- **調整範囲**: 1秒〜5分
- **表示形式**: 1分未満は「○秒」、1分以上は「○分○秒」

## 📁 ファイル構成

```
vue-vad01/
├── server.py                    # FastAPIサーバー
├── package.json                 # Node.js依存関係
├── pyproject.toml               # Python依存関係（rye）
├── index.html                   # エントリーポイント
├── vite.config.ts               # Vite設定
├── tsconfig.json                # TypeScript設定
├── src/
│   ├── main.ts                  # Vue.jsメイン
│   ├── App.vue                  # メインコンポーネント
│   ├── components/
│   │   ├── AudioMonitor.vue     # 音声モニター
│   │   ├── AudioRecorder.vue    # 録音機能
│   │   └── RecordingHistory.vue # 録音履歴
│   └── composables/
│       ├── useAudioMonitor.ts   # 音声解析
│       └── useAudioDevices.ts   # デバイス管理
├── recordings/                  # 録音ファイル保存先
└── dist/                        # ビルド出力先
```

## 🔧 技術スタック

### フロントエンド
- **Vue 3**: リアクティブフレームワーク
- **TypeScript**: 型安全性
- **Vite**: 高速開発サーバー
- **Element Plus**: UIコンポーネント
- **Web Audio API**: 音声解析
- **MediaRecorder API**: 録音機能

### バックエンド
- **FastAPI**: 高性能WebAPIフレームワーク
- **WebSocket**: リアルタイム通信
- **uvicorn**: ASGIサーバー

### 開発・管理ツール
- **rye**: Python依存関係管理
- **npm**: Node.js依存関係管理
- **concurrently**: 複数プロセス同時実行

## 📝 トラブルシューティング

### マイクアクセスが許可されない
- ブラウザの設定でマイクアクセスを許可
- HTTPSでないとマイクアクセスが制限される場合があります
- プライベートブラウジングモードでは制限される場合があります

### 録音ファイルが保存されない
- `recordings/` ディレクトリが存在することを確認
- サーバーが正常に起動していることを確認
- WebSocket接続エラーがないかコンソールを確認
- ポート8000が他のプロセスに使用されていないか確認

### 音声が検出されない
- マイクの音量設定を確認
- VAD閾値スライダーで感度を調整
- 適切なマイクデバイスが選択されているか確認
- 環境ノイズレベルと比較して閾値を調整

### 自動録音が動作しない
- 自動録音タブが選択されているか確認
- 「自動録音開始」ボタンが押されているか確認
- VAD閾値が適切に設定されているか確認
- 無音時間設定が適切か確認

## 📈 今後の拡張予定

- [ ] WebRTC VADライブラリ（@ricky0123/vad-web）の本格統合
- [ ] 録音形式の選択（WAV/WebM/MP3）
- [ ] 録音ファイルのダウンロード機能
- [ ] 複数ファイルの一括操作
- [ ] 録音品質設定（サンプルレート、ビットレート）
- [ ] 音声前処理（ノイズ除去、音量正規化）
- [ ] WebSocket自動再接続機能
- [ ] 録音のスケジュール機能

---

## 💻 開発者向け情報

### 利用可能なコマンド

```bash
# フロントエンド
npm run dev          # 開発サーバー起動
npm run build        # プロダクションビルド
npm run serve        # FastAPIサーバー起動（rye経由）
npm start            # サーバー + フロントエンド同時起動

# Python（rye使用）
rye sync             # 依存関係インストール
rye run python server.py  # サーバー起動
```

### API エンドポイント

#### WebSocket
- `ws://localhost:8000/ws/audio` - 音声データのリアルタイム送信

#### REST API
- `GET /recordings` - 録音ファイル一覧取得
- `GET /recordings/{filename}` - 録音ファイル取得
- `DELETE /recordings/{filename}` - 録音ファイル削除

### 開発設定

- **ホットリロード**: Vite開発サーバーによる自動更新
- **型チェック**: TypeScript strict mode
- **リンター**: ESLint設定（推奨）
- **フォーマッター**: Prettier設定（推奨）

### デバッグ情報

開発者ツールのコンソールで以下の情報を確認できます：
- VAD状態の変化
- WebSocket接続状況
- 音声解析データ
- エラーメッセージ